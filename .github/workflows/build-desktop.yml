name: Build Desktop App

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ------------------------------------------------------------------
      # NOTE: This workflow assumes the repository root IS 'ting-reader-client'
      # so we run commands in the root (.) or ./frontend
      # ------------------------------------------------------------------

      - name: Get version from package.json
        id: get_version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      - name: Install Desktop Dependencies
        working-directory: .
        run: npm install

      # Linux specific setup for electron-builder (snapcraft, etc if needed)
      # Usually 'npm run electron:build' handles appimage/deb/rpm/snap if configured.
      # For now, we assume default targets.

      - name: Build Desktop App
        working-directory: .
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run electron:build -- --publish never
        # 'publish: never' because we upload manually later or rely on softprops/action-gh-release
        
      # Upload Artifacts
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TingReader-Client-${{ matrix.os }}-v${{ env.VERSION }}
          path: |
            dist_electron/*.exe
            dist_electron/*.dmg
            dist_electron/*.zip
            dist_electron/*.AppImage
            dist_electron/*.deb
            dist_electron/*.rpm
          retention-days: 5

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: get_version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      # Create Tag
      - name: Update Git Tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -f v${{ env.VERSION }}
          git push origin v${{ env.VERSION }} --force

      # Extract Release Notes
      - name: Extract Release Notes
        id: extract_notes
        shell: bash
        run: |
          VERSION="${{ env.VERSION }}"
          if [ -f CHANGELOG.md ]; then
            START_LINE=$(grep -n "## \[$VERSION\]" CHANGELOG.md | cut -d: -f1)
            if [ -n "$START_LINE" ]; then
              tail -n +$START_LINE CHANGELOG.md | sed -n '1p; 2,${/## \[/q; p}' > RELEASE_NOTES.md
            else
              echo "Version $VERSION not found in CHANGELOG.md"
              echo "Release v$VERSION" > RELEASE_NOTES.md
            fi
          else
            echo "Release v$VERSION" > RELEASE_NOTES.md
          fi

      # Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.yml
            artifacts/**/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
